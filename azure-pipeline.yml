trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: varcody  # Grupo de variables con credenciales de JFrog

steps:

# ğŸ”¹ Verificar e instalar JFrog CLI solo si no estÃ¡ instalado
- script: |
    if ! command -v jf &> /dev/null; then
      echo "JFrog CLI no encontrado, instalando..."
      curl -fL https://install-cli.jfrog.io | sh
      echo "InstalaciÃ³n completada."

      # Agregar JFrog CLI al PATH si estÃ¡ en ~/.jfrog/current
      if [ -f "$HOME/.jfrog/current/jf" ]; then
        echo 'export PATH=$HOME/.jfrog/current:$PATH' >> ~/.bashrc
        export PATH=$HOME/.jfrog/current:$PATH
      elif [ -f "/usr/local/bin/jf" ]; then
        echo "JFrog CLI encontrado en /usr/local/bin"
      else
        echo "Error: No se encontrÃ³ el binario de JFrog CLI despuÃ©s de la instalaciÃ³n."
        exit 1
      fi
    else
      echo "JFrog CLI ya estÃ¡ instalado."
    fi

    # Verificar instalaciÃ³n final
    source ~/.bashrc
    jf --version || { echo "Error: JFrog CLI no estÃ¡ accesible."; exit 1; }
  displayName: 'Verificar e instalar JFrog CLI si es necesario'

# ğŸ”¹ Configurar JFrog CLI en modo no interactivo
- script: |
    export CI=true
    jf c add jfrogmdevops \
      --artifactory-url=$(JFROGA_URL) \
      --user=$(JFROG_USERNAME) \
      --password=$(JFROG_APITOKEN) \
      --interactive=false
  displayName: 'Configurar JFrog CLI en modo no interactivo'

# ğŸ”¹ Configurar PyPI en Artifactory correctamente (resolver y deploy)
- script: |
    export CI=true
    jf rt pip-config \
      --server-id-resolve=$(JFROG_SERVER) \
      --repo-resolve=$(REPO_PYPI) \
      --server-id-deploy=$(JFROG_SERVER) \
      --repo-deploy=$(REPO_PYPI) \
      --global
  displayName: 'Configurar PyPI con Artifactory correctamente'

# ğŸ”¹ Verificar y actualizar herramientas de compilaciÃ³n si es necesario
- script: |
    if ! dpkg -l | grep -E 'python3-pip|python3-setuptools|python3-wheel|ninja-build'; then
      sudo apt-get update && sudo apt-get install -y python3-pip python3-setuptools python3-wheel ninja-build
    fi
    pip show meson >/dev/null 2>&1 || pip install --upgrade meson
  displayName: 'Verificar y actualizar herramientas de compilaciÃ³n si es necesario'

# ğŸ”¹ Verificar que ninja estÃ¡ instalado y en el PATH
- script: |
    if ! command -v ninja &>/dev/null; then
      echo "Ninja no encontrado. Instalando..."
      sudo apt-get update && sudo apt-get install -y ninja-build
    fi
    echo "Verificando versiÃ³n de Ninja:"
    ninja --version
  displayName: 'Verificar e instalar Ninja si es necesario'

# ğŸ”¹ Verificar e instalar pycairo si es necesario
- script: |
    export PATH=$PATH:/usr/bin
    pip show pycairo >/dev/null 2>&1 || pip install --no-cache-dir --index-url=https://pypi.org/simple pycairo
  displayName: 'Verificar e instalar pycairo si es necesario'

# ğŸ”¹ Generar lista de dependencias
- script: |
    pip freeze > requirements.txt
  displayName: 'Generar requirements.txt'

# ğŸ”¹ Verificar quÃ© paquetes faltan en Artifactory
- script: |
    echo "ğŸ“Œ Verificando dependencias en Artifactory..."
    
    # Obtener lista de paquetes en Artifactory
    jf rt s "pypi-local/*" | grep '"name"' | awk -F '"' '{print $4}' > artifactory_packages.txt

    # Obtener lista de paquetes en requirements.txt
    awk -F '==' '{print $1}' requirements.txt > local_packages.txt

    # Comparar listas y detectar paquetes faltantes
    missing_packages=$(comm -23 <(sort local_packages.txt) <(sort artifactory_packages.txt))

    if [ -z "$missing_packages" ]; then
      echo "âœ… Todas las dependencias estÃ¡n en Artifactory."
    else
      echo "ğŸš¨ Faltan estos paquetes en Artifactory:"
      echo "$missing_packages"

      # Descargar y subir paquetes faltantes
      pip download -r requirements.txt -d .
      jf rt u "*.whl" pypi-local/
    fi
  displayName: 'Verificar y subir dependencias faltantes a Artifactory'

# ğŸ”¹ Subir todas las dependencias a Artifactory con build info
- script: |
    jf pip install -r requirements.txt --no-cache-dir --force-reinstall --build-name=$(PACKAGE_NAME) --build-number=$(BUILD_NUMBER)
    jf rt bp $(PACKAGE_NAME) $(BUILD_NUMBER)
  displayName: 'Subir dependencias a Artifactory'

# ğŸ”¹ Descargar dependencias desde Artifactory asegurando versiÃ³n correcta
- script: |
    if [ -f requirements.txt ] && [ -s requirements.txt ]; then
        echo "ğŸ“Œ Descargando dependencias desde Artifactory..."
        pip install --no-cache-dir -r requirements.txt
    else
        echo "ğŸš¨ Error: requirements.txt no encontrado o vacÃ­o."
        exit 1
    fi
  displayName: 'Descargar dependencias desde Artifactory'
